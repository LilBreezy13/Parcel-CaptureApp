<!doctype html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Parcel Officer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-300">

  <!-- Navbar -->
  <header class="bg-white dark:bg-gray-800 shadow-md p-3 sm:p-4 flex items-center justify-between">
    <h1 class="text-base sm:text-lg font-semibold">Parcel Officer Dashboard</h1>
    <div class="flex items-center gap-3 sm:gap-4">
      <!-- Theme Toggle -->
      <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:scale-110 transition text-sm sm:text-base">🌙</button>
      <!-- Notifications -->
      <div class="relative">
        <button id="notifBtn" class="relative p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:scale-110 transition text-sm sm:text-base">🔔
          <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full px-1">0</span>
        </button>
        <div id="notifDropdown" class="hidden absolute right-0 mt-2 w-56 sm:w-64 bg-white dark:bg-gray-800 shadow-lg rounded-md p-3 text-xs sm:text-sm z-50">
          <p class="font-semibold mb-2">New Submissions</p>
          <ul id="notifList" class="space-y-2 text-xs"></ul>
        </div>
      </div>
      <!-- Profile -->
      <div class="flex items-center gap-2">
        <span class="hidden sm:block font-medium">Officer</span>
        <img src="https://via.placeholder.com/32" alt="profile" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full border-2 border-blue-600">
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-2 sm:p-4 max-w-7xl mx-auto w-full flex flex-col">
    <!-- Metrics -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-2 sm:gap-4 mb-4 sm:mb-6 text-xs sm:text-sm">
      <div id="metricRejected" class="p-3 sm:p-4 rounded-xl shadow bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Rejected: <b>0</b></div>
      <div id="metricShortages" class="p-3 sm:p-4 rounded-xl shadow bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">Shortages: <b>0</b></div>
      <div id="metricNew" class="p-3 sm:p-4 rounded-xl shadow bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">New Schools: <b>0</b></div>
      <div id="metricPaid" class="p-3 sm:p-4 rounded-xl shadow bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Paid: <b>0</b></div>
      <div id="metricPart" class="p-3 sm:p-4 rounded-xl shadow bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">Part Payment: <b>0</b> / Not Paid: <b>0</b></div>
    </div>

    <!-- Search & Export -->
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 items-stretch sm:items-center mb-4 sm:mb-6">
      <input id="searchInput" placeholder="Search by name, address, phone or date..." class="border rounded-md p-2 flex-1 text-xs sm:text-sm dark:bg-gray-700 dark:border-gray-600">
      <select id="statusFilter" class="border rounded-md p-2 text-xs sm:text-sm dark:bg-gray-700 dark:border-gray-600">
        <option value="all">All Statuses</option>
        <option value="rejected">Rejected</option>
        <option value="shortages">Shortages</option>
        <option value="new_school">New School</option>
        <option value="paid">Paid</option>
        <option value="part_payment">Part Payment</option>
        <option value="not_paid">Not Paid</option>
      </select>
      <button id="exportCsv" class="px-3 sm:px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md text-xs sm:text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Export CSV</button>
    </div>

    <!-- Day Sheets -->
    <div id="daySheets" class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 rounded-xl shadow p-3 sm:p-4 transition text-xs sm:text-sm">
      <div id="sheet-today" class="day-sheet">
        <h2 class="text-sm sm:text-lg font-semibold mb-2 sm:mb-3">Today</h2>
        <div id="parcelList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"></div>
      </div>
      <!-- optional other sheets (yesterday, older) can be added similarly -->
    </div>

    <!-- Sheet Tabs -->
    <div class="flex gap-2 mt-3 sm:mt-4 overflow-x-auto border-t pt-2 dark:border-gray-700 text-xs sm:text-sm">
      <button onclick="showSheet('today')" class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-md">Today</button>
      <button onclick="showSheet('yesterday')" class="px-3 sm:px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Yesterday</button>
      <button onclick="showSheet('older')" class="px-3 sm:px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Older</button>
    </div>
  </main>

  <!-- Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg max-w-3xl w-full relative transition text-xs sm:text-sm">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">✖</button>
      <h2 class="text-sm sm:text-lg font-semibold mb-2">Parcel Details</h2>
      <div id="modalContent" class="space-y-2"></div>
    </div>
  </div>

  <footer class="bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 p-3 sm:p-4 text-center text-xs sm:text-sm">Parcel Officer Dashboard • TailwindCSS</footer>

<script type="module">
  // Firebase (matches the config you provided)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ---------------------------
  // UI helpers (theme, modal, sheets)
  // ---------------------------
  const toggle = document.getElementById('themeToggle');
  if (toggle) {
    toggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      toggle.textContent = document.documentElement.classList.contains('dark') ? '☀️' : '🌙';
    });
  }

  window.openModal = function (html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('detailModal').classList.remove('hidden');
  };
  window.closeModal = function () {
    document.getElementById('detailModal').classList.add('hidden');
  };

  window.showSheet = function (id) {
    document.querySelectorAll('.day-sheet').forEach(sheet => sheet.classList.add('hidden'));
    const active = document.getElementById('sheet-' + id);
    if (active) active.classList.remove('hidden');
  };

  // notif dropdown toggle
  const notifBtn = document.getElementById('notifBtn');
  const notifDropdown = document.getElementById('notifDropdown');
  const notifListEl = document.getElementById('notifList');
  const notifBadge = document.getElementById('notifBadge');
  if (notifBtn) notifBtn.addEventListener('click', () => notifDropdown.classList.toggle('hidden'));

  // ---------------------------
  // Firebase initialization
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyB_gTuAS9i-jywpFYLmMEunh2KJmsCW1_o",
    authDomain: "employee-app-c781d.firebaseapp.com",
    projectId: "employee-app-c781d",
    storageBucket: "employee-app-c781d.appspot.com",
    messagingSenderId: "232631444018",
    appId: "1:232631444018:web:37b70fe37975abcc1b922b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------------------
  // Helpers
  // ---------------------------
  function formatTimestamp(ts) {
    if (!ts) return '';
    // Firestore Timestamp object
    if (typeof ts.toDate === 'function') {
      return ts.toDate().toLocaleString();
    }
    // If it's seconds/nanos object
    if (ts.seconds) {
      return new Date(ts.seconds * 1000).toLocaleString();
    }
    // string or number fallback
    try { return new Date(ts).toLocaleString(); } catch { return ''; }
  }

  function createBadge(text, colorClass = 'bg-green-200 text-green-800') {
    return `<span class="px-2 py-1 text-xs rounded-full ${colorClass} dark:bg-opacity-80">${text}</span>`;
  }

  // ---------------------------
  // Real-time listener
  // ---------------------------
  const parcelList = document.getElementById("parcelList");
  const q = query(collection(db, "parcels"), orderBy("timestamp", "desc"));

  // Keep simple metrics counting
  function updateMetrics(docs) {
    let rejected=0, shortages=0, newSchool=0, paid=0, part=0, notPaid=0;
    docs.forEach(d => {
      const data = d.data();
      const s1 = (data.status1 || '').toLowerCase();
      const s2 = (data.status2 || '').toLowerCase();
      if (s1.includes('rejected') || s2.includes('rejected')) rejected++;
      if (s1.includes('shortages') || s2.includes('shortages')) shortages++;
      if (s1.includes('new') || s2.includes('new')) newSchool++;
      if (s2.includes('paid') || s1.includes('paid')) paid += (data.photoCount?0:0); // keep simple
      if (s2.includes('part payment') || s1.includes('part payment')) part++;
      if (s2.includes('not paid') || s1.includes('not paid')) notPaid++;
    });
    document.getElementById('metricRejected').innerHTML = `Rejected: <b>${rejected}</b>`;
    document.getElementById('metricShortages').innerHTML = `Shortages: <b>${shortages}</b>`;
    document.getElementById('metricNew').innerHTML = `New Schools: <b>${newSchool}</b>`;
    document.getElementById('metricPaid').innerHTML = `Paid: <b>${paid}</b>`;
    document.getElementById('metricPart').innerHTML = `Part Payment: <b>${part}</b> / Not Paid: <b>${notPaid}</b>`;
  }

  // Build card and modal content safely
  onSnapshot(q, (snapshot) => {
    // update notifications & metrics
    updateMetrics(snapshot.docs);

    // show notification badge = number of new docs in the snapshot (simple)
    const newCount = snapshot.docs.length;
    notifBadge.textContent = newCount > 0 ? String(newCount) : "0";

    parcelList.innerHTML = "";
    notifListEl.innerHTML = "";

    snapshot.forEach((doc) => {
      const data = doc.data();

      // normalize fields (capture page uses name/address/phone/capturer)
      const title = data.name || data.school || 'Unnamed Parcel';
      const location = data.address || data.location || '';
      const contact = data.phone || data.contact || '';
      const capturer = data.capturer || data.officer || '';
      const photos = Array.isArray(data.photos) ? data.photos : [];
      const photoCount = data.photoCount || photos.length || 0;
      const tsText = formatTimestamp(data.timestamp);
      const statusText = [data.status1, data.status2].filter(Boolean).join(' • ') || (data.status || 'Pending');

      // small image strip (limit to 3)
      const imagesHtml = photos.length > 0
        ? photos.slice(0,3).map(url => `<img src="${url}" class="w-40 h-28 object-cover rounded-md">`).join('')
        : `<img src="https://via.placeholder.com/400x200" class="w-40 h-28 object-cover rounded-md">`;

      // create card
      const card = document.createElement("div");
      card.className = "bg-gray-50 dark:bg-gray-700 p-3 sm:p-4 rounded-xl shadow hover:shadow-lg transition";

      card.innerHTML = `
        <div class="flex gap-2 overflow-x-auto mb-2 sm:mb-3">${imagesHtml}</div>
        <h3 class="font-semibold text-sm sm:text-base">${escapeHtml(title)}</h3>
        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">${escapeHtml(location)}</p>
        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">Contact: ${escapeHtml(contact)}</p>
        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">Captured by: ${escapeHtml(capturer)} ${tsText ? ' at ' + tsText : ''}</p>
        <div class="flex flex-wrap gap-2 mt-2">
          ${createBadge(escapeHtml(statusText))}
        </div>
        <div class="flex flex-wrap gap-2 mt-3">
          <button class="view-btn px-3 py-1 text-xs sm:text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">View</button>
        </div>
      `;

      // append card
      parcelList.appendChild(card);

      // add to notifications list
      const notifItem = document.createElement('li');
      notifItem.className = 'p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700';
      notifItem.textContent = `${title} — ${statusText || 'Pending'}`;
      notifListEl.appendChild(notifItem);

      // view button handler -> open modal with full details
      const viewBtn = card.querySelector('.view-btn');
      viewBtn.addEventListener('click', () => {
        const photosHtmlFull = photos.length > 0
          ? photos.map(url => `<img src="${url}" class="w-48 h-32 object-cover rounded-md">`).join('')
          : `<img src="https://via.placeholder.com/500x300" class="w-48 h-32 object-cover rounded-md">`;

        const modalHtml = `
          <div class="flex gap-2 overflow-x-auto mb-3">${photosHtmlFull}</div>
          <p><b>Name:</b> ${escapeHtml(title)}</p>
          <p><b>Address:</b> ${escapeHtml(location)}</p>
          <p><b>Phone:</b> ${escapeHtml(contact)}</p>
          <p><b>Captured by:</b> ${escapeHtml(capturer)} ${tsText ? ' at ' + tsText : ''}</p>
          <p><b>Status:</b> ${escapeHtml(statusText)}</p>
          <p><b>Photos:</b> ${photoCount}</p>
          <p class="text-xs text-gray-500 mt-2">Doc ID: ${doc.id}</p>
        `;
        openModal(modalHtml);
      });
    });
  });

  // very small helper to avoid accidental raw HTML injection in text fields
  function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // ---------------------------
  // CSV Export (simple)
  // ---------------------------
  document.getElementById('exportCsv').addEventListener('click', async () => {
    // quick export: fetch all parcels once (not realtime)
    const snapshot = await (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js")).getDocs(collection(db, 'parcels'));
    const rows = [['id','name','address','phone','capturer','status1','status2','photoCount','timestamp']];
    snapshot.forEach(doc => {
      const d = doc.data();
      rows.push([
        doc.id,
        d.name || d.school || '',
        d.address || d.location || '',
        d.phone || d.contact || '',
        d.capturer || d.officer || '',
        d.status1 || '',
        d.status2 || '',
        d.photoCount || 0,
        formatTimestamp(d.timestamp)
      ]);
    });
    const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `parcels_export_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // ---------------------------
  // Optional: simple search filter (client-side)
  // ---------------------------
  const searchInput = document.getElementById('searchInput');
  let searchTimeout = null;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      // simple client-side filter: hide cards that don't match query
      const q = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('#parcelList > div').forEach(card => {
        if (!q) { card.style.display = ''; return; }
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(q) ? '' : 'none';
      });
    }, 250);
  });

</script>
</body>
</html>
