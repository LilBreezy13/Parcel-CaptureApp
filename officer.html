<!doctype html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Parcel Officer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-300">

  <!-- Navbar -->
  <header class="bg-white dark:bg-gray-800 shadow-md p-3 sm:p-4 flex items-center justify-between">
    <h1 class="text-base sm:text-lg font-semibold">Parcel Officer Dashboard</h1>
    <div class="flex items-center gap-3 sm:gap-4">
      <!-- Theme Toggle -->
      <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:scale-110 transition text-sm sm:text-base">ðŸŒ™</button>
      <!-- Notifications -->
      <div class="relative">
        <button id="notifBtn" class="relative p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:scale-110 transition text-sm sm:text-base">ðŸ””
          <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full px-1">0</span>
        </button>
        <div id="notifDropdown" class="hidden absolute right-0 mt-2 w-56 sm:w-64 bg-white dark:bg-gray-800 shadow-lg rounded-md p-3 text-xs sm:text-sm z-50">
          <p class="font-semibold mb-2">New Submissions</p>
          <ul id="notifList" class="space-y-2 text-xs"></ul>
        </div>
      </div>
      <!-- Profile -->
      <div class="flex items-center gap-2">
        <span class="hidden sm:block font-medium" id="profileName">Officer</span>
        <img src="https://via.placeholder.com/32" alt="profile" id="profileImg" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full border-2 border-blue-600">
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-2 sm:p-4 max-w-7xl mx-auto w-full flex flex-col">
    <!-- Metrics -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-5 gap-2 sm:gap-4 mb-4 sm:mb-6 text-xs sm:text-sm">
      <div id="metricRejected" class="p-3 sm:p-4 rounded-xl shadow bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Rejected: <b>0</b></div>
      <div id="metricShortages" class="p-3 sm:p-4 rounded-xl shadow bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">Shortages: <b>0</b></div>
      <div id="metricNew" class="p-3 sm:p-4 rounded-xl shadow bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">New Schools: <b>0</b></div>
      <div id="metricPaid" class="p-3 sm:p-4 rounded-xl shadow bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Paid: <b>0</b></div>
      <div id="metricPart" class="p-3 sm:p-4 rounded-xl shadow bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">Part Payment: <b>0</b> / Not Paid: <b>0</b></div>
    </div>

    <!-- Search & Export -->
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 items-stretch sm:items-center mb-4 sm:mb-6">
      <input id="searchInput" placeholder="Search by name, address, phone or date..." class="border rounded-md p-2 flex-1 text-xs sm:text-sm dark:bg-gray-700 dark:border-gray-600">
      <select id="statusFilter" class="border rounded-md p-2 text-xs sm:text-sm dark:bg-gray-700 dark:border-gray-600">
        <option value="all">All Statuses</option>
        <option value="rejected">Rejected</option>
        <option value="shortages">Shortages</option>
        <option value="new_school">New School</option>
        <option value="paid">Paid</option>
        <option value="part_payment">Part Payment</option>
        <option value="not_paid">Not Paid</option>
      </select>
      <button id="exportCsv" class="px-3 sm:px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md text-xs sm:text-sm hover:bg-gray-300 dark:hover:bg-gray-600">Export CSV</button>
    </div>

    <!-- Day Sheets -->
    <div id="daySheets" class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 rounded-xl shadow p-3 sm:p-4 transition text-xs sm:text-sm"></div>

    <!-- Sheet Tabs -->
    <div id="tabsContainer" class="flex gap-2 mt-3 sm:mt-4 overflow-x-auto border-t pt-2 dark:border-gray-700 text-xs sm:text-sm"></div>
  </main>

  <!-- Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg max-w-3xl w-full relative transition text-xs sm:text-sm">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">âœ–</button>
      <h2 class="text-sm sm:text-lg font-semibold mb-2">Parcel Details</h2>
      <div id="modalContent" class="space-y-2"></div>
    </div>
  </div>

  <footer class="bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 p-3 sm:p-4 text-center text-xs sm:text-sm">Parcel Officer Dashboard â€¢ Designed by Nicholas</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------------------------
// UI helpers
// ---------------------------
const toggle=document.getElementById('themeToggle');
toggle.addEventListener('click',()=>{document.documentElement.classList.toggle('dark'); toggle.textContent=document.documentElement.classList.contains('dark')?'â˜€ï¸':'ðŸŒ™';});
window.openModal=html=>{document.getElementById('modalContent').innerHTML=html; document.getElementById('detailModal').classList.remove('hidden');};
window.closeModal=()=>{document.getElementById('detailModal').classList.add('hidden');};
window.showSheet=id=>{
  document.querySelectorAll('.day-sheet').forEach(s=>s.classList.add('hidden'));
  const active=document.getElementById('sheet-'+id);
  if(active) active.classList.remove('hidden');
};

// ---------------------------
// Firebase init
// ---------------------------
const firebaseConfig={
  apiKey:"AIzaSyB_gTuAS9i-jywpFYLmMEunh2KJmsCW1_o",
  authDomain:"employee-app-c781d.firebaseapp.com",
  projectId:"employee-app-c781d",
  storageBucket:"employee-app-c781d.appspot.com",
  messagingSenderId:"232631444018",
  appId:"1:232631444018:web:37b70fe37975abcc1b922b"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

// ---------------------------
// Helpers
// ---------------------------
function formatTimestamp(ts){if(!ts)return''; if(typeof ts.toDate==='function')return ts.toDate().toLocaleString(); if(ts.seconds)return new Date(ts.seconds*1000).toLocaleString(); try{return new Date(ts).toLocaleString()}catch{return''}}
function createBadge(text,colorClass='bg-green-200 text-green-800'){return`<span class="px-2 py-1 text-xs rounded-full ${colorClass} dark:bg-opacity-80">${text}</span>`;}
function escapeHtml(unsafe){if(unsafe===null||unsafe===undefined)return''; return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');}

// ---------------------------
// Realtime listener
// ---------------------------
const notifBtn=document.getElementById('notifBtn');
const notifDropdown=document.getElementById('notifDropdown');
const notifListEl=document.getElementById('notifList');
const notifBadge=document.getElementById('notifBadge');

notifBtn.addEventListener('click',()=>{notifDropdown.classList.toggle('hidden'); if(notifDropdown.classList.contains('hidden')) notifBadge.textContent='0';});

const parcelsQuery=query(collection(db,'parcels'),orderBy('timestamp','desc'));
onSnapshot(parcelsQuery,snapshot=>{
  // organize parcels by date
  const today=new Date(); today.setHours(0,0,0,0);
  const yesterday=new Date(today); yesterday.setDate(today.getDate()-1);
  const older={}; const byDate={today:[], yesterday:[]};
  snapshot.docs.forEach(doc=>{
    const data=doc.data();
    const ts=data.timestamp?new Date(data.timestamp.seconds*1000):new Date();
    ts.setHours(0,0,0,0);
    const diff=(today-ts)/(1000*60*60*24);
    if(diff<1) byDate.today.push({...data,id:doc.id});
    else if(diff<2) byDate.yesterday.push({...data,id:doc.id});
    else{
      const dStr=ts.toISOString().split('T')[0];
      if(!older[dStr]) older[dStr]=[];
      older[dStr].push({...data,id:doc.id});
    }
  });

  // build tabs
  const daySheets=document.getElementById('daySheets');
  const tabsContainer=document.getElementById('tabsContainer');
  daySheets.innerHTML=''; tabsContainer.innerHTML='';
  const allDates=[{key:'today',label:'Today',parcels:byDate.today},{key:'yesterday',label:'Yesterday',parcels:byDate.yesterday}];
  Object.keys(older).sort().forEach(k=>allDates.push({key:k,label:k,parcels:older[k]}));

  allDates.forEach((day,i)=>{
    const sheet=document.createElement('div');
    sheet.className='day-sheet '+(i>0?'hidden':''); sheet.id='sheet-'+day.key;
    const h=document.createElement('h2'); h.className='text-sm sm:text-lg font-semibold mb-2 sm:mb-3'; h.textContent=day.label; sheet.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4';
    day.parcels.forEach(d=>{
      const photos=(d.photos||[]).slice(0,3).map(u=>`<img src="${u}" class="w-40 h-28 object-cover rounded-md">`).join('')||'<img src="https://via.placeholder.com/400x200" class="w-40 h-28 object-cover rounded-md">';
      const statusText=[d.status1,d.status2].filter(Boolean).join(' â€¢ ')||'Pending';
      const card=document.createElement('div'); card.className='bg-gray-50 dark:bg-gray-700 p-3 sm:p-4 rounded-xl shadow hover:shadow-lg transition';
      card.innerHTML=`<div class="flex gap-2 overflow-x-auto mb-2 sm:mb-3">${photos}</div>
      <h3 class="font-semibold text-sm sm:text-base">${escapeHtml(d.name||d.school||'Unnamed Parcel')}</h3>
      <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">${escapeHtml(d.address||d.location||'')}</p>
      <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">Contact: ${escapeHtml(d.phone||d.contact||'')}</p>
      <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300">Captured by: ${escapeHtml(d.capturer||d.officer||'')} ${d.timestamp? ' at ' + formatTimestamp(d.timestamp):''}</p>
      <div class="flex flex-wrap gap-2 mt-2">${createBadge(statusText)}</div>
      <div class="flex flex-wrap gap-2 mt-3">
        <button class="view-btn px-3 py-1 text-xs sm:text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">View</button>
      </div>`;
      card.querySelector('.view-btn').addEventListener('click',()=>{
        const fullPhotos=(d.photos||[]).map(u=>`<img src="${u}" class="w-48 h-32 object-cover rounded-md">`).join('')||'<img src="https://via.placeholder.com/500x300" class="w-48 h-32 object-cover rounded-md">';
        openModal(`<div class="flex gap-2 overflow-x-auto mb-3">${fullPhotos}</div>
          <p><b>Name:</b> ${escapeHtml(d.name||d.school||'')}</p>
          <p><b>Address:</b> ${escapeHtml(d.address||d.location||'')}</p>
          <p><b>Phone:</b> ${escapeHtml(d.phone||d.contact||'')}</p>
          <p><b>Captured by:</b> ${escapeHtml(d.capturer||d.officer||'')} ${d.timestamp? ' at ' + formatTimestamp(d.timestamp):''}</p>
          <p><b>Status:</b> ${escapeHtml(statusText)}</p>
          <p><b>Photos:</b> ${(d.photos||[]).length}</p>
          <p class="text-xs text-gray-500 mt-2">Doc ID: ${d.id}</p>`);
      });
      grid.appendChild(card);

      // add to notification
      const notifItem=document.createElement('li'); notifItem.className='p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700'; notifItem.textContent=`${d.name||d.school||'Parcel'} â€” ${statusText}`; notifListEl.appendChild(notifItem);
    });
    sheet.appendChild(grid); daySheets.appendChild(sheet);

    const tab=document.createElement('button'); tab.className='px-3 sm:px-4 py-2 rounded-md '+(i===0?'bg-blue-600 text-white':'bg-gray-200 dark:bg-gray-700'); tab.textContent=day.label; tab.addEventListener('click',()=>showSheet(day.key)); tabsContainer.appendChild(tab);
  });

  // update metrics
  let rejected=0, shortages=0, newSchool=0, paid=0, part=0, notPaid=0;
  snapshot.docs.forEach(doc=>{
    const d=doc.data(); const s1=(d.status1||'').toLowerCase(); const s2=(d.status2||'').toLowerCase();
    if(s1.includes('rejected')||s2.includes('rejected')) rejected++;
    if(s1.includes('shortages')||s2.includes('shortages')) shortages++;
    if(s1.includes('new')||s2.includes('new')) newSchool++;
    if(s1.includes('paid')||s2.includes('paid')) paid++;
    if(s1.includes('part payment')||s2.includes('part payment')) part++;
    if(s1.includes('not paid')||s2.includes('not paid')) notPaid++;
  });
  document.getElementById('metricRejected').innerHTML=`Rejected: <b>${rejected}</b>`;
  document.getElementById('metricShortages').innerHTML=`Shortages: <b>${shortages}</b>`;
  document.getElementById('metricNew').innerHTML=`New Schools: <b>${newSchool}</b>`;
  document.getElementById('metricPaid').innerHTML=`Paid: <b>${paid}</b>`;
  document.getElementById('metricPart').innerHTML=`Part Payment: <b>${part}</b> / Not Paid: <b>${notPaid}</b>`;

  // notif badge
  notifBadge.textContent=snapshot.docs.length>0?snapshot.docs.length:'0';
});

// ---------------------------
// Search
// ---------------------------
document.getElementById('searchInput').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('.day-sheet div.grid > div').forEach(card=>{
    const text=card.innerText.toLowerCase(); card.style.display=text.includes(q)?'':'none';
  });
});

// ---------------------------
// Status Filter
// ---------------------------
document.getElementById('statusFilter').addEventListener('change',()=>{
  const filter=document.getElementById('statusFilter').value.toLowerCase();
  document.querySelectorAll('.day-sheet div.grid > div').forEach(card=>{
    const text=card.innerText.toLowerCase();
    card.style.display=(filter==='all'||text.includes(filter))?'':'none';
  });
});

// ---------------------------
// CSV Export
// ---------------------------
document.getElementById('exportCsv').addEventListener('click', async ()=>{
  const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const snapshot = await getDocs(collection(db,'parcels'));
  const rows=[['id','name','address','phone','capturer','status1','status2','photoCount','timestamp']];
  snapshot.forEach(doc=>{
    const d=doc.data();
    rows.push([doc.id,d.name||d.school||'',d.address||d.location||'',d.phone||d.contact||'',d.capturer||d.officer||'',d.status1||'',d.status2||'',d.photos?d.photos.length:0,formatTimestamp(d.timestamp)]);
  });
  const csv=rows.map(r=>r.map(c=>`"${String(c).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`parcels_export_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
